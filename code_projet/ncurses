#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <ncurses.h>

char *clean_char(char *s) {
    while (*s == ' ' || *s == '\t' || *s == '\n' || *s == '\r')
        s++;

    if (*s == '\0')
        return s;

    char *end = s + strlen(s) - 1;
    while (end > s &&
          (*end == ' ' || *end == '\t' || *end == '\n' || *end == '\r')) {
        *end = '\0';
        end--;
    }

    return s;
}


void draw_header() {
    mvprintw(0, 0, "Titre");
    mvhline(1, 0, '=', COLS); // ligne horizontale
}

int draw_data(const char *filename) {
    FILE *f = fopen(filename, "r");
    if (f == NULL) {
        perror("Erreur ouverture fichier");
        return -1;
    }

    mvprintw(0, 0, "%-6s %-6s %-6s %-12s %-6s %-6s %-14s %-20s",
         "PID", "PPID", "STATE", "USER", "%CPU", "%MEM", "TPS_EXEC_MMS", "CMD");
    mvhline(1, 0, '-', COLS);

    char line[255];
    int j = 0;
    while (fgets(line, sizeof(line), f) != NULL) {
        char *s = clean_char(line);
        if (*s == '\0') continue; // ligne vide
        if (*s == '#') continue;  // commentaire

        char *tab[8]; // tableau pour stocker jusqu'à 8 champs
        int time_s = 0, time_m = 0, time_h = 0;


        char *opt = strtok(s, ":");
        for (int i = 0; i < 8; i++) {
            if (i==6) {
                time_s = atoi(clean_char(opt));
                while (time_s>60) {
                    if (time_s>60) {
                        time_m++;
                        time_s-=60;
                    }
                    if (time_m>60) {
                        time_h++;
                        time_m-=60;
                    }
                }
            }
        	tab[i] = clean_char(opt);
        	opt = strtok(NULL, ":");
        }
        char time[16];
        snprintf(time, sizeof(time), "%02d:%02d:%02d", time_h, time_m, time_s);
        mvprintw(j+2, 0,"%-6s %-6s %-6s %-12s %-6s %-6s %-14s %-20s",
        tab[0], tab[1], tab[2], tab[3], tab[4], tab[5], time, tab[7]);
        j++;
    }

    fclose(f);
    return 0;
}


int main() {
    initscr();            // init ncurses
    noecho();             // pas d’écho clavier
    curs_set(FALSE);      // cacher curseur
    keypad(stdscr, TRUE); // activer touches spéciales

    while (1) {
        clear();
        draw_header();

        // tableau de processus fictif
        draw_data("exemple_txt.txt");

        refresh();

        int ch = getch();
        if (ch == 'q') break; // quitter avec 'q'
    }
    endwin();
    return 0;
}
